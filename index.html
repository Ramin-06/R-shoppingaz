<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R-Shoppingaz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --main-blue: #00509d; --dark-blue: #003366; --bright-orange: #ff8c00; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f8f9fa; color: #333; }
        
        /* Səhifə Struktur */
        .page { display: none; padding: 15px; min-height: 100vh; box-sizing: border-box; }
        .page.active { display: block !important; }

        /* Header & Search */
        .header-fixed { position: sticky; top: 0; background: #f8f9fa; z-index: 100; padding: 10px 0; }
        .search-container { background: white; padding: 12px; border-radius: 15px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .search-container input { border: none; outline: none; width: 100%; margin-left: 10px; font-size: 15px; }

        /* Slider */
        .slider-area { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; scrollbar-width: none; }
        .slide-card { min-width: 85%; height: 160px; background: #ddd; border-radius: 20px; overflow: hidden; flex-shrink: 0; }
        .slide-card img { width: 100%; height: 100%; object-fit: cover; }

        /* Product Grid */
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .product-card { background: white; border-radius: 18px; padding: 12px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .product-card h4 { font-size: 14px; margin: 8px 0; height: 35px; overflow: hidden; }
        .price-text { color: var(--main-blue); font-weight: bold; display: block; margin-bottom: 8px; }
        .btn-add { background: var(--bright-orange); color: white; border: none; padding: 10px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { text-align: center; color: #999; font-size: 11px; flex: 1; }
        .nav-item.active { color: var(--main-blue); font-weight: bold; }
        .badge { position: absolute; top: 5px; right: 25%; background: red; color: white; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: none; align-items: center; justify-content: center; }

        /* Modallar */
        #productDetail, #adminLoginModal, #infoModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: none; overflow-y: auto; }
        #adminLoginModal { background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .det-header { padding: 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: white; z-index: 10; }
    </style>
</head>
<body>

    <div id="adminLoginModal">
        <div style="background:white; padding:30px; border-radius:20px; width:80%; max-width:400px; text-align:center;">
            <h3>Admin Girişi</h3>
            <input type="text" id="adminID" placeholder="Admin ID" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">
            <input type="password" id="adminPass" placeholder="Şifrə" style="width:100%; padding:12px; margin-bottom:20px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">
            <button class="btn-add" onclick="checkAdminLogin()">DAXİL OL</button>
            <p onclick="closeAdminLogin()" style="margin-top:15px; color:#666; font-size:14px;">Bağla</p>
        </div>
    </div>

    <div id="infoModal">
        <div class="det-header"><i class="fas fa-arrow-left" onclick="closeInfoModal()"></i> <b>Məlumat</b></div>
        <div style="padding:20px;"></div>
    </div>

    <div id="productDetail">
        <div class="det-header">
            <i class="fas fa-arrow-left" onclick="closeDetail()"></i> 
            <b id="detTitle">Məhsul</b>
            <i class="fas fa-heart" id="detFavBtn" onclick="toggleFavFromDetail()" style="margin-left:auto; color:#ccc;"></i>
        </div>
        <div style="padding:20px; padding-bottom: 120px;">
            <div id="detImg"></div>
            <h2 id="detHeaderName" style="margin:15px 0 5px 0;"></h2>
            <span id="detPrice" style="font-size:22px; color:var(--main-blue); font-weight:bold;"></span>
            
            <div style="margin:20px 0;">
                <p><b>Həcm seçin:</b></p>
                <div style="display:flex; gap:10px;">
                    <button class="size-btn active" style="padding:10px 20px; border-radius:10px; border:1px solid #ddd; background:white;" onclick="updatePrice(this, 30, 10)">30 ml</button>
                    <button class="size-btn" style="padding:10px 20px; border-radius:10px; border:1px solid #ddd; background:white;" onclick="updatePrice(this, 50, 13)">50 ml</button>
                </div>
            </div>

            <div style="display:flex; align-items:center; gap:20px; margin-bottom:25px;">
                <button onclick="changeQty(-1)" style="width:40px; height:40px; border-radius:50%; border:1px solid #ddd;">-</button>
                <b id="qtyVal">1</b>
                <button onclick="changeQty(1)" style="width:40px; height:40px; border-radius:50%; border:1px solid #ddd;">+</button>
            </div>

            <button class="btn-add" onclick="addToCart()" style="padding:15px;">SƏBƏTƏ ƏLAVƏ ET</button>

            <div style="margin-top:30px; line-height:1.6;">
                <p><b>Qoxu:</b> <span id="detNotes"></span></p>
                <p><b>Qalıcılıq:</b> <span id="detStay"></span></p>
                <p><b>Cins:</b> <span id="detCat"></span></p>
            </div>

            <div id="ratingStats" style="margin-top:30px; border-top:1px solid #eee; padding-top:20px;"></div>
            <div id="reviewsList"></div>
        </div>
    </div>

    <div id="homePage" class="page active">
        <div class="header-fixed">
            <center><img src="https://raw.githubusercontent.com/Ramin-06/R-Shoppingaz/main/logo_baslig.png" style="height:35px;"></center>
            <div class="search-container" style="margin-top:10px;">
                <i class="fas fa-search" style="color:#ccc"></i>
                <input type="text" id="searchInput" placeholder="Ətir axtar..." oninput="searchPerfume()">
            </div>
        </div>
        <div class="slider-area" id="slider">
            <div class="slide-card" onclick="openCampaignModal()"><img src="https://raw.githubusercontent.com/Ramin-06/R-Shoppingaz/main/kampaniya_sertleri.jpg"></div>
            <div class="slide-card" onclick="openDeliveryModal()"><img src="https://raw.githubusercontent.com/Ramin-06/R-Shoppingaz/main/xidmetler_ve_catdirilma.jpg"></div>
        </div>
        <h3 id="gridTitle">Məhsullar</h3>
        <div id="homeGrid" class="product-grid"></div>
        <div style="height:80px;"></div>
    </div>

    <div id="catalogPage" class="page">
        <h3>Kataloq</h3>
        <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px;">
            <button class="filter-btn active" onclick="applyFilter('all', this)" style="padding:8px 20px; border-radius:20px; border:1px solid #ddd; white-space:nowrap;">Hamısı</button>
            <button class="filter-btn" onclick="applyFilter('qadin', this)" style="padding:8px 20px; border-radius:20px; border:1px solid #ddd; white-space:nowrap;">Qadın</button>
            <button class="filter-btn" onclick="applyFilter('kisi', this)" style="padding:8px 20px; border-radius:20px; border:1px solid #ddd; white-space:nowrap;">Kişi</button>
        </div>
        <div id="catalogGrid" class="product-grid"></div>
        <div style="height:80px;"></div>
    </div>

    <div id="favPage" class="page">
        <h3>Favorilər</h3>
        <div id="favGrid" class="product-grid"></div>
        <div id="favEmpty" style="display:none; text-align:center; margin-top:50px; color:#999;">Favorit siyahısı boşdur.</div>
    </div>

    <div id="cartPage" class="page">
        <h3>Səbət</h3>
        <div id="cartList"></div>
        <div id="cartFooter" style="margin-top:20px; padding-bottom:100px;"></div>
    </div>

    <div id="adminPage" class="page" style="z-index: 3000;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Admin Panel</h3>
            <button onclick="location.reload()" style="border:none; background:none; color:red;">Çıxış</button>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button id="tabAdd" class="btn-add" onclick="switchAdminTab('add')" style="flex:1">Əlavə et</button>
            <button id="tabList" class="btn-add" onclick="switchAdminTab('list')" style="flex:1; background:#eee; color:#333;">Siyahı</button>
        </div>

        <div id="sectAdd">
            <h4 id="formTitle">Yeni Məhsul</h4>
            <input type="text" id="adminProdName" placeholder="Ad" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">
            <select id="adminProdCat" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;">
                <option value="qadin">Qadın</option>
                <option value="kisi">Kişi</option>
                <option value="unisex">Unisex</option>
            </select>
            <input type="text" id="adminProdNotes" placeholder="Notalar" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">
            <input type="text" id="adminProdStay" placeholder="Qalıcılıq" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">
            <button id="adminSaveBtn" class="btn-add" onclick="saveProductToFirebase()" style="background:#27ae60">ƏLAVƏ ET</button>
            <button id="cancelEditBtn" onclick="resetAdminForm()" style="display:none; width:100%; background:none; border:none; color:red; margin-top:10px;">Ləğv et</button>
        </div>

        <div id="sectList" style="display:none;">
            <div id="adminProductList"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showPage('homePage', this)"><i class="fas fa-home"></i><br>Əsas</div>
        <div class="nav-item" onclick="showPage('catalogPage', this)"><i class="fas fa-th-large"></i><br>Kataloq</div>
        <div class="nav-item" onclick="showPage('favPage', this)"><i class="fas fa-heart"></i><br>Favori</div>
        <div class="nav-item" onclick="showPage('cartPage', this)"><i class="fas fa-shopping-cart"></i><div id="cartBadge" class="badge">0</div><br>Səbət</div>
        <div class="nav-item" onclick="openAdminLogin()"><i class="fas fa-user-lock"></i><br>Admin</div>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyA5eb16DAKSVLkEzYsUrgxL9vfrJP7w-es",
          authDomain: "etir-magazasi-d7679.firebaseapp.com",
          projectId: "etir-magazasi-d7679",
          storageBucket: "etir-magazasi-d7679.firebasestorage.app",
          messagingSenderId: "1045258773680",
          appId: "1:1045258773680:web:ab2edd54ba3f0ef0530775"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let products = [], cart = [], favs = [], currentProd = null;
        let selectedRating = 0, currentQty = 1, selectedSize = 30, currentPrice = 10;
        let editMode = false, editId = null;

        // FETCH PRODUCTS
        async function fetchProducts() {
            db.collection("products").onSnapshot(snapshot => {
                products = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderAll();
            });
        }

        function renderAll() {
            const html = products.map(p => createCard(p)).join('');
            document.getElementById('homeGrid').innerHTML = html;
            document.getElementById('catalogGrid').innerHTML = html;
        }

        function createCard(p) {
            const isFav = favs.some(f => f.id === p.id);
            const img = "https://raw.githubusercontent.com/Ramin-06/R-Shoppingaz/main/card_pic.png";
            return `
                <div class="product-card">
                    <i class="fas fa-heart" style="position:absolute; top:12px; right:12px; color:${isFav?'#ff4757':'#ddd'}" onclick="toggleFav(event, '${p.id}')"></i>
                    <div onclick="openDetail('${p.id}')">
                        <img src="${img}" style="width:100%; height:120px; object-fit:contain;">
                        <h4>${p.name}</h4>
                        <span class="price-text">10 - 13 AZN</span>
                    </div>
                    <button class="btn-add" onclick="openDetail('${p.id}')">Seçim et</button>
                </div>`;
        }

        // NAVIGATION
        function showPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) el.classList.add('active');
            if(id === 'favPage') renderFavs();
            if(id === 'cartPage') renderCart();
        }

        function openDetail(id) {
            currentProd = products.find(p => p.id === id);
            document.getElementById('detHeaderName').innerText = currentProd.name;
            document.getElementById('detPrice').innerText = "10 AZN";
            document.getElementById('detNotes').innerText = currentProd.notes;
            document.getElementById('detStay').innerText = currentProd.stay;
            document.getElementById('detCat').innerText = currentProd.cat;
            document.getElementById('detImg').innerHTML = `<img src="https://raw.githubusercontent.com/Ramin-06/R-Shoppingaz/main/card_pic.png" style="width:100%; max-height:250px; object-fit:contain;">`;
            
            currentQty = 1;
            document.getElementById('qtyVal').innerText = currentQty;
            document.getElementById('productDetail').style.display = 'block';
            fetchReviews(id);
        }

        function closeDetail() { document.getElementById('productDetail').style.display = 'none'; }

        // CART & FAV
        function addToCart() {
            const item = {...currentProd, qty: currentQty, size: selectedSize, price: currentPrice};
            const exist = cart.find(c => c.id === item.id && c.size === item.size);
            if(exist) exist.qty += currentQty; else cart.push(item);
            updateBadge();
            closeDetail();
        }

        function updateBadge() {
            const count = cart.reduce((s, i) => s + i.qty, 0);
            const b = document.getElementById('cartBadge');
            b.innerText = count;
            b.style.display = count > 0 ? 'flex' : 'none';
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            const footer = document.getElementById('cartFooter');
            if(cart.length === 0) {
                list.innerHTML = "<center style='padding:50px;'>Səbət boşdur</center>";
                footer.innerHTML = "";
                return;
            }
            let total = 0;
            list.innerHTML = cart.map((item, i) => {
                total += item.price * item.qty;
                return `<div style="background:white; padding:15px; border-radius:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${item.name}</b> (${item.size}ml)<br>${item.qty} x ${item.price} AZN</div>
                    <i class="fas fa-trash" style="color:red" onclick="remCart(${i})"></i>
                </div>`;
            }).join('');
            footer.innerHTML = `<h3 style="display:flex; justify-content:space-between;">Cəmi: <span>${total} AZN</span></h3>
            <button class="btn-add" onclick="checkout()" style="background:var(--main-blue); padding:15px;">SİFARİŞİ TAMAMLA</button>`;
        }

        function remCart(i) { cart.splice(i, 1); updateBadge(); renderCart(); }

        function toggleFav(e, id) {
            e.stopPropagation();
            const idx = favs.findIndex(f => f.id === id);
            if(idx > -1) favs.splice(idx, 1);
            else favs.push(products.find(p => p.id === id));
            renderAll();
        }

        // ADMIN LOGIN
        function openAdminLogin() { document.getElementById('adminLoginModal').style.display = 'flex'; }
        function closeAdminLogin() { document.getElementById('adminLoginModal').style.display = 'none'; }

        async function checkAdminLogin() {
            const id = document.getElementById('adminID').value;
            const pass = document.getElementById('adminPass').value;
            const snap = await db.collection("admins").get();
            let auth = false;
            snap.forEach(doc => {
                if(doc.data().adminID == id && doc.data().password == pass) auth = true;
            });
            if(auth) {
                closeAdminLogin();
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('adminPage').classList.add('active');
                document.querySelector('.bottom-nav').style.display = 'none';
                renderAdminList();
            } else {
                alert("Yanlış məlumat!");
            }
        }

        // ADMIN FUNCTIONS
        function switchAdminTab(t) {
            document.getElementById('sectAdd').style.display = t === 'add' ? 'block' : 'none';
            document.getElementById('sectList').style.display = t === 'list' ? 'block' : 'none';
        }

        async function saveProductToFirebase() {
            const data = {
                name: document.getElementById('adminProdName').value,
                cat: document.getElementById('adminProdCat').value,
                notes: document.getElementById('adminProdNotes').value,
                stay: document.getElementById('adminProdStay').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            if(editMode) await db.collection("products").doc(editId).update(data);
            else await db.collection("products").add(data);
            resetAdminForm();
            alert("Uğurla yadda saxlanıldı!");
        }

        function renderAdminList() {
            document.getElementById('adminProductList').innerHTML = products.map(p => `
                <div style="background:white; padding:15px; border-radius:15px; margin-bottom:10px; display:flex; justify-content:space-between;">
                    <div><b>${p.name}</b><br><small>${p.cat}</small></div>
                    <div>
                        <i class="fas fa-edit" style="color:orange; margin-right:15px;" onclick="editProduct('${p.id}')"></i>
                        <i class="fas fa-trash" style="color:red;" onclick="deleteProduct('${p.id}')"></i>
                    </div>
                </div>`).join('');
        }

        function editProduct(id) {
            const p = products.find(i => i.id === id);
            document.getElementById('adminProdName').value = p.name;
            document.getElementById('adminProdCat').value = p.cat;
            document.getElementById('adminProdNotes').value = p.notes;
            document.getElementById('adminProdStay').value = p.stay;
            editMode = true; editId = id;
            document.getElementById('adminSaveBtn').innerText = "YENİLƏ";
            document.getElementById('cancelEditBtn').style.display = "block";
            switchAdminTab('add');
        }

        function resetAdminForm() {
            editMode = false; editId = null;
            document.getElementById('adminProdName').value = "";
            document.getElementById('adminSaveBtn').innerText = "ƏLAVƏ ET";
            document.getElementById('cancelEditBtn').style.display = "none";
        }

        async function deleteProduct(id) {
            if(confirm("Silinsin?")) await db.collection("products").doc(id).delete();
        }

        // WHATSAPP
        function checkout() {
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            let msg = "*YENİ SİFARİŞ*\n\n";
            cart.forEach(i => msg += `• ${i.name} (${i.size}ml) - ${i.qty} ədəd\n`);
            msg += `\n*Cəmi:* ${total} AZN`;
            window.location.href = `https://wa.me/994515817772?text=${encodeURIComponent(msg)}`;
        }

        // INFO MODALS
        function openInfoModal(content) {
            document.getElementById('infoModal').style.display = 'block';
            document.querySelector('#infoModal div[style="padding:20px;"]').innerHTML = content;
        }
        function closeInfoModal() { document.getElementById('infoModal').style.display = 'none'; }

        function openCampaignModal() { openInfoModal("<h3>Kampaniya</h3>Beş ətir alana çatdırılma pulsuzdur!"); }
        function openDeliveryModal() { openInfoModal("<h3>Çatdırılma</h3>Rayonlara poçtla göndərilir."); }

        // INITIALIZE
        fetchProducts();
    </script>
</body>
</html>
